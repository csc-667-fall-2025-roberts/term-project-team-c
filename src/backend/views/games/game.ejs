<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Game <%= id %> - Go Fish</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="stylesheet" href="/css/bundle.css" />
    <script type="module" src="/js/game.js" defer></script>
    <script type="module" src="/js/dev-menu.js" defer></script>
  </head>
  <body>
    <div class="game-container">
      <!-- Header -->
      <div class="game-header card">
        <h1>
          <span class="fish-logo">üêü</span>
          <%= name || `Game ${id}` %>
          <span class="game-meta-info">
            ‚Ä¢ <%= state %> ‚Ä¢ <%= max_players %> players max
          </span>
        </h1>
        <a href="/lobby" class="btn-link">‚Üê Back to Lobby</a>
      </div>

      <!-- Main Game Layout: Game Board + Chat -->
      <div class="game-layout">
        <!-- Left: Game Board -->
        <div class="game-main">
          <!-- Opponents Area -->
          <div class="opponents-area">
            <% if (typeof players !== 'undefined' && players && players.length > 0) { %>
              <!-- Real opponents from data -->
              <% players.filter(p => p.user_id !== currentUserId).forEach((player, i) => { %>
                <div class="opponent-card" data-user-id="<%= player.user_id %>">
                  <h3>
                    <img src="https://api.dicebear.com/7.x/fun-emoji/svg?seed=<%= player.username %>" alt="" class="player-avatar player-<%= (i % 4) + 2 %>" />
                    <%= player.username %>
                  </h3>
                  <div class="opponent-hand">
                    <% for (let j = 0; j < (player.card_count || 0); j++) { %>
                      <div class="playing-card back"></div>
                    <% } %>
                  </div>
                  <div class="opponent-stats"><%= player.card_count || 0 %> cards ‚Ä¢ <%= player.book_count || 0 %> books</div>
                </div>
              <% }) %>
            <% } else { %>
              <!-- PLACEHOLDER: Remove this else block after Session 2 wires up players -->
              <div class="opponent-card" data-user-id="0">
                <h3>
                  <img src="https://api.dicebear.com/7.x/fun-emoji/svg?seed=kenji" alt="" class="player-avatar player-2" />
                  kenji
                </h3>
                <div class="opponent-hand">
                  <div class="playing-card back"></div>
                  <div class="playing-card back"></div>
                  <div class="playing-card back"></div>
                  <div class="playing-card back"></div>
                  <div class="playing-card back"></div>
                </div>
                <div class="opponent-stats">5 cards ‚Ä¢ 0 books</div>
              </div>

              <div class="opponent-card" data-user-id="0">
                <h3>
                  <img src="https://api.dicebear.com/7.x/fun-emoji/svg?seed=priya" alt="" class="player-avatar player-3" />
                  priya
                </h3>
                <div class="opponent-hand">
                  <div class="playing-card back"></div>
                  <div class="playing-card back"></div>
                  <div class="playing-card back"></div>
                </div>
                <div class="opponent-stats">3 cards ‚Ä¢ 1 book</div>
              </div>

              <div class="opponent-card" data-user-id="0">
                <h3>
                  <img src="https://api.dicebear.com/7.x/fun-emoji/svg?seed=omar" alt="" class="player-avatar player-4" />
                  omar
                </h3>
                <div class="opponent-hand">
                  <div class="playing-card back"></div>
                  <div class="playing-card back"></div>
                  <div class="playing-card back"></div>
                  <div class="playing-card back"></div>
                </div>
                <div class="opponent-stats">4 cards ‚Ä¢ 0 books</div>
              </div>
            <% } %>
          </div>

          <!-- Center: Deck & All Books -->
          <div class="center-game-area">
            <div class="deck-section">
              <h3>Deck</h3>
              <div class="deck-pile">
                <div class="playing-card back"></div>
              </div>
              <% if (typeof deckCount !== 'undefined') { %>
                <div class="deck-count"><%= deckCount %> cards remaining</div>
              <% } else { %>
                <div class="deck-count">28 cards remaining</div>
              <% } %>
            </div>

            <div class="all-books-section">
              <%
                const allRanks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
                const completedBooks = (typeof allBooks !== 'undefined' && allBooks) ? allBooks : [];
                const bookCount = completedBooks.length;
              %>
              <h3>All Books (<%= bookCount %>/13 Complete)</h3>
              <div class="books-list">
                <% allRanks.forEach(rank => { %>
                  <% const book = completedBooks.find(b => b.rank === rank); %>
                  <% if (book) { %>
                    <span class="book-badge completed" title="<%= book.username %>"><%= rank %></span>
                  <% } else { %>
                    <span class="book-badge placeholder"><%= rank %></span>
                  <% } %>
                <% }) %>
              </div>
            </div>
          </div>

          <!-- Player Hand -->
          <div class="player-area card <%= (typeof currentTurnUserId !== 'undefined' && currentTurnUserId === currentUserId) ? 'active-turn' : '' %>">
            <%
              const myPlayer = (typeof players !== 'undefined' && players)
                ? players.find(p => p.user_id === currentUserId)
                : null;
              const myCardCount = (typeof myCards !== 'undefined' && myCards) ? myCards.length : 6;
              const myBookCount = myPlayer ? myPlayer.book_count : 2;
              const myUsername = myPlayer ? myPlayer.username : 'You';
            %>
            <h3>
              <img src="https://api.dicebear.com/7.x/fun-emoji/svg?seed=<%= myUsername %>" alt="" class="player-avatar player-1" />
              <%= myUsername %> (<%= myCardCount %> cards) ‚Ä¢ <%= myBookCount %> books
              <% if (typeof currentTurnUserId !== 'undefined' && currentTurnUserId === currentUserId) { %>
                <span class="turn-indicator">‚Äî Your Turn!</span>
              <% } %>
            </h3>

            <div class="player-hand">
              <% if (typeof myCards === 'undefined') { %>
                <!-- PLACEHOLDER: Remove this if block after Session 1 wires up myCards -->
                <div class="playing-card suit-H rank-A" data-rank="A"></div>
                <div class="playing-card suit-D rank-5" data-rank="5"></div>
                <div class="playing-card suit-C rank-5" data-rank="5"></div>
                <div class="playing-card suit-S rank-J" data-rank="J"></div>
                <div class="playing-card suit-H rank-Q" data-rank="Q"></div>
                <div class="playing-card suit-D rank-2" data-rank="2"></div>
              <% } else { %>
                <!-- Real cards from data (empty if no cards yet) -->
                <% myCards.forEach(card => { %>
                  <div class="playing-card suit-<%= card.suit %> rank-<%= card.rank %>" data-rank="<%= card.rank %>" data-suit="<%= card.suit %>"></div>
                <% }) %>
              <% } %>
            </div>
          </div>
        </div>

        <!-- Right: Game Chat -->
        <div class="game-chat">
          <div class="card game-chat-area">
            <h2>Game Chat</h2>
            <div id="chat-area">
              <div id="message-listing" class="message-listing">
                <!-- Placeholder messages - will be replaced by real chat -->
                <div class="chat-message system">
                  <div class="message-header">
                    <span class="message-username">Game</span>
                    <span class="message-time">--:--</span>
                  </div>
                  <span class="message-text">Game chat will appear here...</span>
                </div>
              </div>

              <div id="message-submit" class="message-submit">
                <input type="text" placeholder="Enter your message" />
                <button class="btn-primary">Send</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Card template for JavaScript rendering -->
    <template id="card-template">
      <div class="playing-card"></div>
    </template>
  </body>
</html>
